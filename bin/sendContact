#!/usr/bin/env node

var sg  = require('sendgrid')(process.env.SENDGRID_API_KEY);

var Airtable = require('airtable');
var base = new Airtable({apiKey: 'key6ENmDOrXqkC5Fu'}).base('appRsi6hgpkmwzLBg');

var folksToContact = [];
var sendString = "";

base('Contacts').select({
		    view: "Catch up due"
		}).eachPage(function page(records, fetchNextPage) {
		    // This function (`page`) will get called for each page of records.

		    records.forEach(function(record) {
		        folksToContact.push(record.get('Name'));
		    });

		    // To fetch the next page of records, call `fetchNextPage`.
		    // If there are more records, `page` will get called again.
		    // If there are no more records, `done` will get called.
		    sendString = folksToContact.join(', ')


		    fetchNextPage();

		}, function done(err) {
		    if (err) { 
		    	console.error(err); 
		    	return; 
			} else {


				var request = sg.emptyRequest({
				  method: 'POST',
				  path: '/v3/mail/send',
				  body: {
				    personalizations: [
				      {
				        to: [
				          {
				            email: 'anirudh.c.mohan@gmail.com',
				          },
				        ],
				        subject: 'Folks to follow up with',
				      },
				    ],
				    from: {
				      email: 'test@example.com',
				    },
				    content: [
				      {
				        type: 'text/plain',
				        value: sendString
				      },
				    ],
				  },
				});

				sg.API(request, function(error, response) {
				  if (error) {
				    console.log('Error response received');
				  }
				  console.log(response.statusCode);
				  console.log(response.body);
				  console.log(response.headers);
				});
		} 
});



