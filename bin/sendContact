#!/usr/bin/env node

var sg  = require('sendgrid')(
  process.env.SENDGRID_USERNAME,
  process.env.SENDGRID_PASSWORD
);

var Airtable = require('airtable');
var base = new Airtable({apiKey: 'key6ENmDOrXqkC5Fu'}).base('appRsi6hgpkmwzLBg');

var folksToContact = [];
var sendString = "";

base('Contacts').select({
		    view: "Catch up due"
		}).eachPage(function page(records, fetchNextPage) {
		    // This function (`page`) will get called for each page of records.

		    records.forEach(function(record) {
		        folksToContact.push(record.get('Name'));
		    });

		    // To fetch the next page of records, call `fetchNextPage`.
		    // If there are more records, `page` will get called again.
		    // If there are no more records, `done` will get called.
		    sendString = folksToContact.toString()


		    fetchNextPage();

		}, function done(err) {
		    if (err) { 
		    	console.error(err); 
		    	return; 
			} else {
				sg.send({
				    to: 'anirudh.c.mohan@gmail.com',
				    from: 'app@email.com',
				    subject: 'Folks to follow up with',
				    text: sendString
				  }, function(err, json) {
				    if (err) { 
				      console.error(err); 
				    }   
				});
		} 
});



